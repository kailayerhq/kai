# GitLab CI for Kailab
# Builds and deploys to GKE on merge to main

stages:
  - test
  - build
  - release
  - deploy

variables:
  # Image names (Artifact Registry)
  KAILAB_IMAGE: us-central1-docker.pkg.dev/$GCP_PROJECT_ID/preplan/kailab
  KAILAB_CONTROL_IMAGE: us-central1-docker.pkg.dev/$GCP_PROJECT_ID/preplan/kailab-control

# Reusable GCP auth (key is base64 encoded)
.gcp_auth: &gcp_auth
  - apk add --no-cache docker-cli
  - echo "$GCP_SERVICE_KEY" | base64 -d > /tmp/gcp-key.json
  - gcloud auth activate-service-account --key-file=/tmp/gcp-key.json
  - gcloud config set project $GCP_PROJECT_ID
  - gcloud auth configure-docker us-central1-docker.pkg.dev --quiet

.gke_auth: &gke_auth
  - gcloud components install kubectl gke-gcloud-auth-plugin --quiet
  - gcloud container clusters get-credentials $GKE_CLUSTER --zone $GKE_ZONE

# Test kai-cli (needs CGO for tree-sitter)
test:kai-cli:
  stage: test
  image: golang:1.24-alpine
  before_script:
    - apk add --no-cache gcc musl-dev
  script:
    - cd kai-cli
    - CGO_ENABLED=1 go test ./...

# Test kai-core (needs CGO for tree-sitter)
test:kai-core:
  stage: test
  image: golang:1.24-alpine
  before_script:
    - apk add --no-cache gcc musl-dev
  script:
    - cd kai-core
    - CGO_ENABLED=1 go test ./...

# Test kailab (needs CGO for sqlite)
test:kailab:
  stage: test
  image: golang:1.24-alpine
  before_script:
    - apk add --no-cache gcc musl-dev
  script:
    - cd kailab
    - CGO_ENABLED=1 go test ./...

# Test kailab-control
test:kailab-control:
  stage: test
  image: golang:1.24-alpine
  script:
    - cd kailab-control
    - go test ./...

# Build kailab (data plane)
build:kailab:
  stage: build
  image: google/cloud-sdk:alpine
  services:
    - docker:dind
  variables:
    DOCKER_HOST: tcp://docker:2375
  before_script:
    - *gcp_auth
  script:
    - docker build -t $KAILAB_IMAGE:$CI_COMMIT_SHA -t $KAILAB_IMAGE:latest -f kailab/Dockerfile .
    - docker push $KAILAB_IMAGE:$CI_COMMIT_SHA
    - docker push $KAILAB_IMAGE:latest
  only:
    - main
    - tags

# Build kailab-control (control plane)
build:kailab-control:
  stage: build
  image: google/cloud-sdk:alpine
  services:
    - docker:dind
  variables:
    DOCKER_HOST: tcp://docker:2375
  before_script:
    - *gcp_auth
  script:
    - docker build -t $KAILAB_CONTROL_IMAGE:$CI_COMMIT_SHA -t $KAILAB_CONTROL_IMAGE:latest kailab-control/
    - docker push $KAILAB_CONTROL_IMAGE:$CI_COMMIT_SHA
    - docker push $KAILAB_CONTROL_IMAGE:latest
  only:
    - main
    - tags

# Build and release kai-cli binaries
# Uploads to GitLab Generic Package Registry
release:kai-cli:
  stage: release
  image: golang:1.24-alpine
  before_script:
    - apk add --no-cache gcc musl-dev git curl
  script:
    - cd kai-cli
    - VERSION=$(grep 'var Version' cmd/kai/main.go | cut -d'"' -f2)
    - echo "Building kai-cli v${VERSION}"
    - mkdir -p dist
    # Linux amd64 (native build on Alpine)
    - CGO_ENABLED=1 GOOS=linux GOARCH=amd64 go build -ldflags="-s -w" -o dist/kai-linux-amd64 ./cmd/kai
    - gzip -k dist/kai-linux-amd64
    # Upload to GitLab Package Registry
    - |
      curl --header "JOB-TOKEN: ${CI_JOB_TOKEN}" \
           --upload-file dist/kai-linux-amd64.gz \
           "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/kai-cli/${VERSION}/kai-linux-amd64.gz"
    - |
      curl --header "JOB-TOKEN: ${CI_JOB_TOKEN}" \
           --upload-file dist/kai-linux-amd64.gz \
           "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/kai-cli/latest/kai-linux-amd64.gz"
  only:
    - main
    - tags
  artifacts:
    paths:
      - kai-cli/dist/
    expire_in: 1 week

# Build macOS binaries (requires macOS runner, run manually for now)
# release:kai-cli:macos:
#   stage: release
#   tags:
#     - macos
#   script:
#     - cd kai-cli
#     - VERSION=$(grep 'var Version' cmd/kai/main.go | cut -d'"' -f2)
#     - CGO_ENABLED=1 GOOS=darwin GOARCH=amd64 go build -ldflags="-s -w" -o dist/kai-darwin-amd64 ./cmd/kai
#     - CGO_ENABLED=1 GOOS=darwin GOARCH=arm64 go build -ldflags="-s -w" -o dist/kai-darwin-arm64 ./cmd/kai
#   only:
#     - tags

# Deploy to GKE
deploy:
  stage: deploy
  image: google/cloud-sdk:alpine
  before_script:
    - *gcp_auth
    - *gke_auth
  script:
    # Create namespace if not exists
    - kubectl create namespace kailab --dry-run=client -o yaml | kubectl apply -f -
    # Update image tags in manifest and apply
    - sed -i "s|us-central1-docker.pkg.dev/preplanai/preplan/kailab:latest|$KAILAB_IMAGE:$CI_COMMIT_SHA|g" deploy/k8s/kailab-deployment.yaml
    - sed -i "s|us-central1-docker.pkg.dev/preplanai/preplan/kailab-control:latest|$KAILAB_CONTROL_IMAGE:$CI_COMMIT_SHA|g" deploy/k8s/kailab-deployment.yaml
    - kubectl apply -f deploy/k8s/kailab-deployment.yaml
    # Wait for rollout
    - kubectl rollout status deployment/kailab -n kailab --timeout=300s
    - kubectl rollout status deployment/kailab-control -n kailab --timeout=300s
  only:
    - main
  environment:
    name: production
    url: https://kaiscm.com
