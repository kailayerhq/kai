# GitLab CI for Kailab
# Builds and deploys to GKE on merge to main

stages:
  - test
  - build
  - deploy

variables:
  # Image names (Artifact Registry)
  KAILAB_IMAGE: us-central1-docker.pkg.dev/$GCP_PROJECT_ID/preplan/kailab
  KAILAB_CONTROL_IMAGE: us-central1-docker.pkg.dev/$GCP_PROJECT_ID/preplan/kailab-control

# Reusable GCP auth (key is base64 encoded)
.gcp_auth: &gcp_auth
  - apk add --no-cache docker-cli
  - echo "$GCP_SERVICE_KEY" | base64 -d > /tmp/gcp-key.json
  - gcloud auth activate-service-account --key-file=/tmp/gcp-key.json
  - gcloud config set project $GCP_PROJECT_ID
  - gcloud auth configure-docker us-central1-docker.pkg.dev --quiet

.gke_auth: &gke_auth
  - gcloud components install kubectl gke-gcloud-auth-plugin --quiet
  - gcloud container clusters get-credentials $GKE_CLUSTER --zone $GKE_ZONE

# Test kai-cli (needs CGO for tree-sitter)
test:kai-cli:
  stage: test
  image: golang:1.24-alpine
  before_script:
    - apk add --no-cache gcc musl-dev
  script:
    - cd kai-cli
    - CGO_ENABLED=1 go test ./...

# Test kai-core (needs CGO for tree-sitter)
test:kai-core:
  stage: test
  image: golang:1.24-alpine
  before_script:
    - apk add --no-cache gcc musl-dev
  script:
    - cd kai-core
    - CGO_ENABLED=1 go test ./...

# Test kailab (needs CGO for sqlite)
test:kailab:
  stage: test
  image: golang:1.24-alpine
  before_script:
    - apk add --no-cache gcc musl-dev
  script:
    - cd kailab
    - CGO_ENABLED=1 go test ./...

# Test kailab-control
test:kailab-control:
  stage: test
  image: golang:1.24-alpine
  script:
    - cd kailab-control
    - go test ./...

# Build kailab (data plane)
build:kailab:
  stage: build
  image: google/cloud-sdk:alpine
  services:
    - docker:dind
  variables:
    DOCKER_HOST: tcp://docker:2375
  before_script:
    - *gcp_auth
  script:
    - docker build -t $KAILAB_IMAGE:$CI_COMMIT_SHA -t $KAILAB_IMAGE:latest -f kailab/Dockerfile .
    - docker push $KAILAB_IMAGE:$CI_COMMIT_SHA
    - docker push $KAILAB_IMAGE:latest
  only:
    - main
    - tags

# Build kailab-control (control plane)
build:kailab-control:
  stage: build
  image: google/cloud-sdk:alpine
  services:
    - docker:dind
  variables:
    DOCKER_HOST: tcp://docker:2375
  before_script:
    - *gcp_auth
  script:
    - docker build -t $KAILAB_CONTROL_IMAGE:$CI_COMMIT_SHA -t $KAILAB_CONTROL_IMAGE:latest kailab-control/
    - docker push $KAILAB_CONTROL_IMAGE:$CI_COMMIT_SHA
    - docker push $KAILAB_CONTROL_IMAGE:latest
  only:
    - main
    - tags

# Deploy to GKE
deploy:
  stage: deploy
  image: google/cloud-sdk:alpine
  before_script:
    - *gcp_auth
    - *gke_auth
  script:
    # Create namespace if not exists
    - kubectl create namespace kailab --dry-run=client -o yaml | kubectl apply -f -
    # Update image tags in manifest and apply
    - sed -i "s|us-central1-docker.pkg.dev/preplanai/preplan/kailab:latest|$KAILAB_IMAGE:$CI_COMMIT_SHA|g" deploy/k8s/kailab-deployment.yaml
    - sed -i "s|us-central1-docker.pkg.dev/preplanai/preplan/kailab-control:latest|$KAILAB_CONTROL_IMAGE:$CI_COMMIT_SHA|g" deploy/k8s/kailab-deployment.yaml
    - kubectl apply -f deploy/k8s/kailab-deployment.yaml
    # Wait for rollout
    - kubectl rollout status deployment/kailab -n kailab --timeout=300s
    - kubectl rollout status deployment/kailab-control -n kailab --timeout=300s
  only:
    - main
  environment:
    name: production
    url: https://kaiscm.com
